# Rediså¢å¼ºè§£æå™¨

åŸºäºmyRedisCaptureré¡¹ç›®é‡æ„çš„Redisåè®®è§£æå™¨ï¼Œå®ç°äº†è¯·æ±‚å“åº”å…³è”ã€æ•°æ®åº“è·Ÿè¸ªç­‰å¢å¼ºåŠŸèƒ½ã€‚

## ä¸»è¦ç‰¹æ€§

### âœ¨ æ ¸å¿ƒåŠŸèƒ½
- **è¯·æ±‚å“åº”å…³è”**: è‡ªåŠ¨åŒ¹é…Redisè¯·æ±‚å’Œå“åº”ï¼Œè®¡ç®—å‡†ç¡®çš„è€—æ—¶
- **æ•°æ®åº“è·Ÿè¸ª**: ç›‘æ§SELECTå‘½ä»¤ï¼Œè·Ÿè¸ªå½“å‰ä½¿ç”¨çš„æ•°æ®åº“
- **å†…å®¹æˆªæ–­**: è¯·æ±‚ä½“å’Œå“åº”ä½“è‡ªåŠ¨æˆªæ–­åˆ°64ä¸ªå­—ç¬¦
- **å®æ—¶ç›‘æ§**: å®æ—¶æ˜¾ç¤ºRedisæ“ä½œçš„è¯¦ç»†ä¿¡æ¯
- **é”™è¯¯å¤„ç†**: è¯†åˆ«å’Œå¤„ç†Redisé”™è¯¯å“åº”

### ğŸ“Š è¾“å‡ºæ ¼å¼
```
HH:MM:SS.mmm db=X cmd=å‘½ä»¤ key=é”®å req=è¯·æ±‚å†…å®¹ resp=å“åº”å†…å®¹ cost=è€—æ—¶Î¼s
```

ç¤ºä¾‹è¾“å‡ºï¼š
```
15:04:05.123 db=0 cmd=set key=mykey01 req=hello world resp=OK cost=1245Î¼s
15:04:05.456 db=0 cmd=get key=mykey01 req=mykey01 resp=hello world cost=892Î¼s
15:04:06.789 db=1 cmd=set key=another_key req=value1 resp=OK cost=2134Î¼s
```

## æŠ€æœ¯æ¶æ„

### ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶

1. **RedisEnhancedParser**: å¢å¼ºçš„Redisåè®®è§£æå™¨
   - æ”¯æŒRESPåè®®å®Œæ•´è§£æ
   - è¯·æ±‚å“åº”IDç”Ÿæˆå’ŒåŒ¹é…
   - æ•°æ®åº“çŠ¶æ€è·Ÿè¸ª

2. **RequestResponseMatcher**: è¯·æ±‚å“åº”åŒ¹é…å™¨
   - åŸºäºè¿æ¥çš„è¯·æ±‚å“åº”å…³è”
   - 30ç§’è¶…æ—¶è‡ªåŠ¨æ¸…ç†
   - æ”¯æŒå¹¶å‘å®‰å…¨æ“ä½œ

3. **RedisDatabaseTracker**: æ•°æ®åº“è·Ÿè¸ªå™¨
   - ç›‘æ§SELECTå‘½ä»¤
   - æŒ‰è¿æ¥è·Ÿè¸ªæ•°æ®åº“çŠ¶æ€
   - æ”¯æŒå¤šè¿æ¥å¹¶å‘

4. **RedisMonitor**: Redisç›‘æ§å™¨
   - åè°ƒè¯·æ±‚å“åº”åŒ¹é…
   - ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
   - æ ¼å¼åŒ–è¾“å‡º

### ğŸ”„ å·¥ä½œæµç¨‹

```mermaid
graph TB
    A[ç½‘ç»œæ•°æ®åŒ…] --> B[åè®®è¯†åˆ«]
    B --> C{è¯·æ±‚/å“åº”?}
    C -->|è¯·æ±‚| D[è§£æè¯·æ±‚]
    C -->|å“åº”| E[è§£æå“åº”]
    D --> F[æ³¨å†Œå¾…åŒ¹é…]
    E --> G[æŸ¥æ‰¾åŒ¹é…è¯·æ±‚]
    G --> H[ç”Ÿæˆå…³è”ç»“æœ]
    H --> I[æ ¼å¼åŒ–è¾“å‡º]
    D --> J[æ•°æ®åº“è·Ÿè¸ª]
    J --> K[æ›´æ–°DBçŠ¶æ€]
```

## ä½¿ç”¨æ–¹æ³•

### ğŸš€ å¿«é€Ÿå¼€å§‹

1. **ç¼–è¯‘ç¨‹åº**
   ```bash
   go build -o redis_enhanced_monitor redis_enhanced_main.go
   ```

2. **å¯åŠ¨ç›‘æ§** (éœ€è¦ç®¡ç†å‘˜æƒé™)
   ```bash
   sudo ./redis_enhanced_monitor -interface eth0
   ```

3. **æ‰§è¡ŒRediså‘½ä»¤**
   ```bash
   redis-cli SET mykey "hello world"
   redis-cli GET mykey
   ```

4. **æŸ¥çœ‹è¾“å‡º**
   ```
   15:04:05.123 db=0 cmd=set key=mykey req=hello world resp=OK cost=1245Î¼s
   15:04:05.456 db=0 cmd=get key=mykey req=mykey resp=hello world cost=892Î¼s
   ```

### ğŸ“‹ å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `-interface` | - | ç½‘ç»œæ¥å£åç§° (å¿…éœ€) |
| `-host` | 127.0.0.1 | Redisä¸»æœºåœ°å€ |
| `-port` | 6379 | Redisç«¯å£å· |
| `-verbose` | false | è¯¦ç»†è¾“å‡ºæ¨¡å¼ |
| `-snaplen` | 65536 | æŠ“åŒ…é•¿åº¦ |
| `-timeout` | 30s | è¯»å–è¶…æ—¶ |
| `-promisc` | false | æ··æ‚æ¨¡å¼ |

### ğŸ§ª æµ‹è¯•ç¤ºä¾‹

#### Windowsç”¨æˆ·
```cmd
test_redis_enhanced.bat
```

#### Linux/Macç”¨æˆ·
```bash
./test_redis_enhanced.sh
```

## ä»£ç ç»“æ„

```
middle/
â”œâ”€â”€ parsers/
â”‚   â”œâ”€â”€ redis_enhanced.go      # å¢å¼ºRedisè§£æå™¨
â”‚   â”œâ”€â”€ redis.go              # åŸå§‹Redisè§£æå™¨  
â”‚   â””â”€â”€ parser.go             # è§£æå™¨å·¥å‚
â”œâ”€â”€ monitor/
â”‚   â”œâ”€â”€ redis_monitor.go      # Redisç›‘æ§å™¨
â”‚   â””â”€â”€ monitor.go           # é€šç”¨ç›‘æ§å™¨
â”œâ”€â”€ types/
â”‚   â””â”€â”€ types.go             # ç±»å‹å®šä¹‰
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ redis_enhanced_example.go  # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ redis_enhanced_main.go    # å¢å¼ºç›‘æ§ä¸»ç¨‹åº
â””â”€â”€ README_REDIS_ENHANCED.md  # æœ¬æ–‡æ¡£
```

## æ ¸å¿ƒAPI

### RedisEnhancedParser

```go
// åˆ›å»ºè§£æå™¨
parser := NewRedisEnhancedParser(&RedisParserConfig{
    MaxContentLength: 64,
    EnableDBTracking: true,
    Verbose: false,
})

// è§£æè¯·æ±‚
request, err := parser.ParseRequest(requestData)

// è§£æå“åº”
response, err := parser.ParseResponse(responseData)

// åŒ¹é…è¯·æ±‚å“åº”
rr := parser.MatchRequestResponse(response)

// æ ¼å¼åŒ–è¾“å‡º
output := parser.FormatRequestResponse(rr)
```

### RedisMonitor

```go
// åˆ›å»ºç›‘æ§å™¨
monitor := NewRedisMonitor(verbose)

// å¤„ç†æ•°æ®åŒ…
err := monitor.ProcessPacket(data, connection)

// è·å–ç»Ÿè®¡ä¿¡æ¯
stats := monitor.GetStats()
```

## ä¸myRedisCapturerçš„å·®å¼‚

### ğŸ”„ é‡æ„æ”¹è¿›

1. **æ¨¡å—åŒ–è®¾è®¡**: å°†è§£æã€åŒ¹é…ã€ç›‘æ§åˆ†ç¦»æˆç‹¬ç«‹æ¨¡å—
2. **Goè¯­è¨€å®ç°**: å®Œå…¨ä½¿ç”¨Goé‡å†™ï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œç»´æŠ¤æ€§
3. **æ¥å£æ ‡å‡†åŒ–**: å®ç°ç»Ÿä¸€çš„åè®®è§£æå™¨æ¥å£
4. **å¹¶å‘å®‰å…¨**: ä½¿ç”¨äº’æ–¥é”ä¿è¯å¤šè¿æ¥å¹¶å‘å®‰å…¨
5. **é…ç½®çµæ´»**: æ”¯æŒè¿è¡Œæ—¶é…ç½®è°ƒæ•´

### ğŸ“ˆ åŠŸèƒ½å¢å¼º

1. **æ›´ç²¾ç¡®çš„åŒ¹é…**: åŸºäºè¿æ¥çš„è¯·æ±‚å“åº”åŒ¹é…ç®—æ³•
2. **æ™ºèƒ½æ•°æ®åº“è·Ÿè¸ª**: è‡ªåŠ¨è·Ÿè¸ªSELECTå‘½ä»¤å’Œæ•°æ®åº“çŠ¶æ€
3. **æ›´å¥½çš„é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯è¯†åˆ«å’Œå¤„ç†æœºåˆ¶
4. **ç»Ÿè®¡ä¿¡æ¯**: æä¾›è¯¦ç»†çš„ç›‘æ§ç»Ÿè®¡æ•°æ®
5. **æ ¼å¼åŒ–è¾“å‡º**: ç»Ÿä¸€çš„è¾“å‡ºæ ¼å¼ï¼Œä¾¿äºæ—¥å¿—åˆ†æ

## æ€§èƒ½ä¼˜åŒ–

### ğŸš„ ä¼˜åŒ–ç­–ç•¥

1. **å†…å­˜æ± **: å¤ç”¨è§£æç¼“å†²åŒºï¼Œå‡å°‘GCå‹åŠ›
2. **è¶…æ—¶æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸçš„å¾…åŒ¹é…è¯·æ±‚
3. **åç¨‹å®‰å…¨**: ä½¿ç”¨è¯»å†™é”ä¼˜åŒ–å¹¶å‘æ€§èƒ½
4. **å­—ç¬¦ä¸²æˆªæ–­**: é™åˆ¶å†…å®¹é•¿åº¦ï¼Œé¿å…å†…å­˜è†¨èƒ€

### ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **å»¶è¿Ÿ**: å¾®ç§’çº§å“åº”æ—¶é—´æµ‹é‡
- **ååé‡**: æ”¯æŒé«˜å¹¶å‘Redisè¿æ¥
- **å†…å­˜**: å›ºå®šå¤§å°çš„åŒ¹é…ç¼“å­˜
- **CPU**: è½»é‡çº§è§£æç®—æ³•

## æ•…éšœæ’é™¤

### âš ï¸ å¸¸è§é—®é¢˜

1. **æƒé™ä¸è¶³**
   ```
   solution: ä½¿ç”¨sudoè¿è¡Œç¨‹åº
   ```

2. **ç½‘ç»œæ¥å£é”™è¯¯**
   ```
   solution: æ£€æŸ¥ç½‘ç»œæ¥å£åç§°ï¼Œä½¿ç”¨ip linkæˆ–ifconfigæŸ¥çœ‹
   ```

3. **æœªåŒ¹é…çš„å“åº”**
   ```
   solution: æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿï¼Œè°ƒæ•´åŒ¹é…è¶…æ—¶æ—¶é—´
   ```

4. **æ•°æ®åº“æ˜¾ç¤ºä¸º"?"**
   ```
   solution: ç¡®ä¿SELECTå‘½ä»¤åœ¨ç›‘æ§å¼€å§‹åæ‰§è¡Œ
   ```

## æ‰©å±•å¼€å‘

### ğŸ› ï¸ è‡ªå®šä¹‰å¼€å‘

1. **æ·»åŠ æ–°å‘½ä»¤æ”¯æŒ**: åœ¨RedisEnhancedParserä¸­æ‰©å±•å‘½ä»¤è¯†åˆ«
2. **è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼**: ä¿®æ”¹FormatRequestResponseæ–¹æ³•
3. **æ·»åŠ ç»Ÿè®¡æŒ‡æ ‡**: åœ¨RedisMonitorä¸­æ‰©å±•ç»Ÿè®¡åŠŸèƒ½
4. **æ”¯æŒæ–°åè®®**: å®ç°ProtocolParseræ¥å£

### ğŸ”Œ é›†æˆç¤ºä¾‹

```go
// é›†æˆåˆ°ç°æœ‰ç›‘æ§ç³»ç»Ÿ
monitor := NewRedisMonitor(true)
monitor.SetCallback(func(rr *types.RequestResponse) {
    // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    sendToMonitoringSystem(rr)
})
```

## è®¸å¯è¯

åŸºäºåŸé¡¹ç›®è®¸å¯è¯ï¼Œä¿æŒå¼€æºåè®®ä¸€è‡´æ€§ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼Œå…±åŒå®Œå–„Redisç›‘æ§åŠŸèƒ½ã€‚